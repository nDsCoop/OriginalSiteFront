{"ast":null,"code":"import { OrderedMap } from \"immutable\";\nexport default class Realtime {\n  constructor(store) {\n    this.store = store;\n    this.ws = null;\n    this.isConnected = false;\n    this.connect();\n  }\n\n  decoMessage(msg) {\n    let message = {};\n\n    try {\n      message = JSON.parse(msg);\n    } catch (err) {\n      console.log(err);\n    }\n  }\n\n  readMessage(msg) {\n    const message = this.decoMessage(msg);\n\n    const action = _.get(message, 'action', '');\n\n    const payload = _.get(message, 'payload', '');\n\n    switch (action) {\n      case 'channel_added':\n        //to do check payload and insert new channel\n        const channelId = `${payload.id}`;\n        const userId = `${payload.userId}`;\n        let channel = {\n          _id: channelId,\n          title: _.get(payload, 'title', ''),\n          lastMessage: _.get(payload, 'lastMessage', ''),\n          members: new OrderedMap(),\n          messages: new OrderedMap(),\n          isNew: false,\n          userId: userId,\n          created: new Date()\n        };\n        store.addChannel(channelId, channel);\n        break;\n\n      default:\n        break;\n    }\n  }\n\n  send(msg = {}) {\n    const isConnected = this.isConnected;\n\n    if (isConnected) {\n      const msgString = JSON.stringify(msg);\n      this.ws.send(msgString);\n    }\n  }\n\n  authentication() {\n    const store = this.store;\n    const tokenId = store.getUserTokenId();\n    const message = {\n      action: 'auth',\n      payload: `${tokenId}`\n    };\n    this.send(message);\n  }\n\n  connect() {\n    const ws = new WebSocket('ws://localhost:8080');\n    this.ws = ws;\n\n    ws.onopen = () => {\n      //tell to server who are you ?\n      this.isConnected = true;\n      this.authentication();\n\n      ws.onmessage = e => {\n        this.readMessage(_.get(e, 'data', ''));\n        console.log(\"Message from server: \", e.data);\n      };\n    };\n\n    ws.onclose = () => {\n      this.isConnected = false; //\n    };\n  }\n\n}","map":{"version":3,"sources":["C:/myProJects/Server/weatherapp/src/realtime.js"],"names":["OrderedMap","Realtime","constructor","store","ws","isConnected","connect","decoMessage","msg","message","JSON","parse","err","console","log","readMessage","action","_","get","payload","channelId","id","userId","channel","_id","title","lastMessage","members","messages","isNew","created","Date","addChannel","send","msgString","stringify","authentication","tokenId","getUserTokenId","WebSocket","onopen","onmessage","e","data","onclose"],"mappings":"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","sourcesContent":["import { OrderedMap } from \"immutable\";\r\n\r\nexport default class Realtime{\r\n\r\n    constructor(store){\r\n        this.store = store;\r\n        this.ws = null;\r\n        this.isConnected = false;\r\n        this.connect();\r\n\r\n    }\r\n    decoMessage(msg){\r\n        let message = {};\r\n        try{\r\n            message = JSON.parse(msg);\r\n        }\r\n        catch(err){\r\n            console.log(err)\r\n        }\r\n    }\r\n    readMessage(msg){\r\n        const message = this.decoMessage(msg);\r\n        const action = _.get(message, 'action', '');\r\n        const payload = _.get(message, 'payload', '');\r\n\r\n        switch(action){\r\n\r\n            case 'channel_added':\r\n\r\n            //to do check payload and insert new channel\r\n            const channelId = `${payload.id}`;\r\n            const userId = `${payload.userId}`;\r\n            let channel = { \r\n                _id:channelId,  \r\n                title: _.get(payload, 'title', '' ),\r\n                lastMessage: _.get(payload, 'lastMessage', ''),\r\n                members: new OrderedMap(),\r\n                messages: new OrderedMap(),\r\n                isNew: false,\r\n                userId: userId,\r\n                created: new Date(),\r\n            };\r\n            store.addChannel(channelId, channel);\r\n            break;\r\n            default:\r\n                break;\r\n        }\r\n    }\r\n    send( msg = {}){\r\n        const isConnected = this.isConnected;\r\n        if(isConnected){\r\n            const msgString = JSON.stringify(msg);\r\n            this.ws.send(msgString);\r\n        }\r\n    }\r\n    authentication(){\r\n        const store = this.store;\r\n        const tokenId = store.getUserTokenId();\r\n        const message = {\r\n            action: 'auth',\r\n            payload: `${tokenId}`\r\n        }\r\n            this.send(message);\r\n    }\r\n\r\n    connect(){\r\n\r\n        const ws = new WebSocket('ws://localhost:8080');\r\n        this.ws = ws;\r\n        ws.onopen = () => {\r\n            //tell to server who are you ?\r\n            this.isConnected = true;\r\n            this.authentication();\r\n            \r\n            ws.onmessage = (e) => {\r\n                this.readMessage(_.get(e, 'data',''));\r\n                console.log(\"Message from server: \", e.data);\r\n            }\r\n        }\r\n        ws.onclose = () => {\r\n            this.isConnected = false;\r\n            //\r\n        }\r\n    }\r\n}"]},"metadata":{},"sourceType":"module"}