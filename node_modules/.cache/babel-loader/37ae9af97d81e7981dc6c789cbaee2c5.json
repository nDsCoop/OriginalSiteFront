{"ast":null,"code":"import { OrderedMap } from 'immutable';\nimport _ from 'lodash';\nimport Service from './service';\nexport default class Store {\n  constructor(appComponent) {\n    this.app = appComponent;\n    this.service = new Service();\n    this.messages = new OrderedMap();\n    this.channels = new OrderedMap();\n    this.activeChannelId = null;\n    this.user = this.getUserFromLocalStorage();\n    this.token = this.getTokenFromLocalStorage();\n    this.users = new OrderedMap();\n    this.search = {\n      users: new OrderedMap()\n    };\n  }\n\n  startSearchUsers(q = \"\") {\n    //query to backend server and get list of users\n    const data = {\n      search: q\n    };\n    this.search.users = this.search.users.clear();\n    this.service.get('api/users/search', data).then(res => {\n      //list off users match\n      const users = _.get(res, 'data', []);\n\n      console.log(\" get of list users \", users);\n    }).catch(err => {\n      console.log(\" searching error\", err);\n    });\n  }\n\n  setUserToken(accessToken) {\n    if (!accessToken) {\n      this.localStorage.removeItem('token');\n      this.token = null;\n      return;\n    }\n\n    this.token = accessToken;\n    localStorage.setItem('token', JSON.stringify(accessToken));\n  }\n\n  signOut() {\n    const userId = `${_.get(this.user, '_id', null)}`;\n    this.user = null;\n    localStorage.removeItem('me');\n    localStorage.removeItem('token');\n\n    if (userId) {\n      this.users = this.users.remove(userId);\n    }\n\n    this.update();\n  }\n\n  getTokenFromLocalStorage() {\n    if (this.token) {\n      return this.token;\n    }\n\n    let token = null;\n    const data = localStorage.getItem('token');\n\n    if (data) {\n      try {\n        token = JSON.parse(data);\n      } catch (err) {\n        console.log(err);\n      }\n    }\n\n    return token;\n  }\n\n  getUserFromLocalStorage() {\n    let user = null;\n    const data = localStorage.getItem('me');\n\n    try {\n      user = JSON.parse(data);\n    } catch (err) {\n      console.log(err);\n    }\n\n    if (user) {\n      //connect to backend server verify this user\n      const token = this.getTokenFromLocalStorage();\n\n      const tokenId = _.get(token, '_id');\n\n      const options = {\n        headers: {\n          authorization: tokenId\n        }\n      };\n      this.service.get('api/users/me', options).then(res => {\n        //user login with token id\n        const accessToken = res.data;\n\n        const user = _.get(accessToken, 'user');\n\n        this.setCurrentUser(user);\n        this.setUserToken(accessToken);\n      }).catch(err => {\n        this.signOut();\n      });\n    }\n\n    return user;\n  }\n\n  setCurrentUser(user) {\n    this.user = user;\n\n    if (user) {\n      localStorage.setItem('me', JSON.stringify(user)); //save to local store\n\n      const userId = `${user._id}`;\n      this.users = this.users.set(userId, user);\n    }\n\n    this.update();\n  }\n\n  login(email = null, password = null) {\n    const userEmail = _.toLower(email);\n\n    const user = {\n      email: userEmail,\n      password: password\n    };\n    console.log(\"Try login with\", user);\n    return new Promise((resolve, reject) => {\n      this.service.post('api/users/login', user).then(res => {\n        //that mean successful login\n        const accessToken = _.get(res, 'data');\n\n        const user = _.get(accessToken, 'user');\n\n        this.setCurrentUser(user);\n        this.setUserToken(accessToken);\n      }).catch(err => {\n        const message = _.get(err, 'res.data.err.message', 'Login Error');\n\n        return reject(message);\n      });\n    }); // const _this = this;\n    // return new Promise((resolve, reject) => {\n    //     const user = users.find((user) => user.email === userEmail);\n    //     if( user ) {\n    //         _this.setCurrentUser(user);\n    //     }\n    //     return user ? resolve(user) : reject(\"User not found!\")\n    // });\n  }\n\n  addUserToChannel(channelId, userId) {\n    const channel = this.channels.get(channelId);\n\n    if (channel) {\n      channel.members = channel.members.set(userId, true);\n      this.channels = this.channels.set(channelId, channel);\n    }\n\n    this.update();\n  }\n\n  getSearchUsers() {\n    // const keyword = _.toLower(search);\n    // let searchItems = new OrderedMap();\n    // const currentUser =this.getCurrentUser();\n    // const currentUserId = _.get(currentUser, '_id');\n    // if(_.trim(search).length){\n    //    searchItems = users.filter((user) =>_.get(user, '_id') !== currentUserId && _.includes(_.toLower(_.get(user, 'name')), keyword));\n    // }\n    return this.search.users.valueSeq();\n  }\n\n  onCreateNewChannel(channel = {}) {\n    const channelId = _.get(channel, \"_id\");\n\n    this.addChannel(channelId, channel);\n    this.setActiveChannelId(channelId);\n  }\n\n  getCurrentUser() {\n    return this.user;\n  }\n\n  setActiveChannelId(id) {\n    this.activeChannelId = id;\n    this.update();\n  }\n\n  getActiveChannel() {\n    const channel = this.activeChannelId ? this.channels.get(this.activeChannelId) : this.channels.first();\n    return channel;\n  }\n\n  addMessage(id, message = {}) {\n    const user = this.getCurrentUser();\n    message.user = user;\n    this.messages = this.messages.set(`${id}`, message); //add new message to \n\n    const channelId = _.get(message, 'channelId');\n\n    if (channelId) {\n      let channel = this.channels.get(channelId);\n      channel.isNew = false;\n      channel.lastMessage = _.get(message, 'body', '');\n      channel.messages = channel.messages.set(id, true);\n      this.channels = this.channels.set(channelId, channel);\n    }\n\n    this.update();\n  }\n\n  removeMemberFromChannel(channel = null, user = null) {\n    if (!channel || !user) {\n      return;\n    }\n\n    const channelId = _.get(channel, '_id');\n\n    const userId = _.get(user, '_id');\n\n    channel.members = channel.members.remove(userId);\n    this.channels = this.channels.set(channelId, channel);\n    this.update();\n  }\n\n  getMessages() {\n    return this.messages.valueSeq();\n  }\n\n  getMessagesFromChannel(channel) {\n    let messages = new OrderedMap();\n\n    if (channel) {\n      channel.messages.forEach((value, key) => {\n        const message = this.messages.get(key);\n        messages = messages.set(key, message);\n      });\n    }\n\n    return messages.valueSeq();\n  }\n\n  getMembersFromChannel(channel) {\n    let members = new OrderedMap();\n\n    if (channel) {\n      channel.members.forEach((value, key) => {\n        const userId = `${key}`;\n        const user = this.users.get(userId);\n        const loggedUser = this.getCurrentUser();\n\n        if (_.get(loggedUser, '_id') !== _.get(user, '_id')) {\n          members = members.set(key, user);\n        }\n      });\n    }\n\n    return members.valueSeq();\n  }\n\n  addChannel(index, channel = {}) {\n    this.channels = this.channels.set(`${index}`, channel);\n    this.update();\n  }\n\n  getChannels() {\n    this.channels = this.channels.sort((a, b) => b.created - a.created);\n    return this.channels.valueSeq();\n  }\n\n  update() {\n    this.app.forceUpdate();\n  }\n\n}","map":{"version":3,"sources":["C:/myProJects/Server/weatherapp/src/store.js"],"names":["OrderedMap","_","Service","Store","constructor","appComponent","app","service","messages","channels","activeChannelId","user","getUserFromLocalStorage","token","getTokenFromLocalStorage","users","search","startSearchUsers","q","data","clear","get","then","res","console","log","catch","err","setUserToken","accessToken","localStorage","removeItem","setItem","JSON","stringify","signOut","userId","remove","update","getItem","parse","tokenId","options","headers","authorization","setCurrentUser","_id","set","login","email","password","userEmail","toLower","Promise","resolve","reject","post","message","addUserToChannel","channelId","channel","members","getSearchUsers","valueSeq","onCreateNewChannel","addChannel","setActiveChannelId","getCurrentUser","id","getActiveChannel","first","addMessage","isNew","lastMessage","removeMemberFromChannel","getMessages","getMessagesFromChannel","forEach","value","key","getMembersFromChannel","loggedUser","index","getChannels","sort","a","b","created","forceUpdate"],"mappings":"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","sourcesContent":["import { OrderedMap } from 'immutable';\r\nimport _ from 'lodash';\r\nimport Service from './service';\r\n\r\n\r\n\r\nexport default class Store {\r\n    constructor(appComponent){\r\n        this.app = appComponent;\r\n        this.service = new Service();\r\n        this.messages = new OrderedMap();\r\n        this.channels = new OrderedMap();\r\n        this.activeChannelId = null;\r\n\r\n        this.user = this.getUserFromLocalStorage();\r\n        this.token = this.getTokenFromLocalStorage();\r\n        this.users = new OrderedMap();\r\n\r\n        this.search = {\r\n            users: new OrderedMap(),\r\n        }\r\n\r\n    }\r\n    startSearchUsers(q = \"\"){\r\n        //query to backend server and get list of users\r\n        const data = {search : q};\r\n        this.search.users = this.search.users.clear();\r\n        this.service.get('api/users/search', data).then((res) => {\r\n            //list off users match\r\n            const users = _.get(res, 'data', []);\r\n            console.log(\" get of list users \", users);\r\n        }).catch((err) => {\r\n            console.log(\" searching error\", err);\r\n        }); \r\n    }\r\n    setUserToken(accessToken){\r\n        if(!accessToken){\r\n            this.localStorage.removeItem('token');\r\n            this.token = null;\r\n            return;\r\n        }\r\n        this.token = accessToken;\r\n        localStorage.setItem('token', JSON.stringify(accessToken));\r\n    }\r\n    signOut(){\r\n        \r\n        const userId = `${_.get(this.user, '_id', null)}`;\r\n        this.user = null;\r\n        localStorage.removeItem('me');\r\n        localStorage.removeItem('token');\r\n        if(userId){\r\n            this.users = this.users.remove(userId);\r\n        }\r\n        this.update();\r\n    }\r\n\r\n    getTokenFromLocalStorage(){\r\n\r\n        if(this.token){\r\n            return this.token;\r\n        }\r\n\r\n        let token = null;\r\n        const data = localStorage.getItem('token');\r\n        if(data){\r\n            try{\r\n                token = JSON.parse(data);\r\n            }\r\n            catch (err){\r\n                console.log(err);\r\n            }\r\n            \r\n        }\r\n        return token;\r\n    }\r\n\r\n    getUserFromLocalStorage(){\r\n\r\n        let user = null;\r\n        const data = localStorage.getItem('me');\r\n         try {\r\n                user = JSON.parse(data);\r\n         }\r\n         catch(err) {\r\n             console.log(err);\r\n         }\r\n         if(user){\r\n            //connect to backend server verify this user\r\n            const token = this.getTokenFromLocalStorage();\r\n            const tokenId = _.get(token, '_id');\r\n            const options = {\r\n                headers: {\r\n                    authorization: tokenId,\r\n                }\r\n            }\r\n            \r\n            this.service.get('api/users/me', options).then((res) => {\r\n                //user login with token id\r\n                const accessToken = res.data;\r\n                const user = _.get(accessToken, 'user');\r\n\r\n                this.setCurrentUser(user);\r\n                this.setUserToken(accessToken);\r\n\r\n            }).catch(err => {\r\n                this.signOut();\r\n            });\r\n        }\r\n\r\n         return user;\r\n    }    \r\n        \r\n    \r\n    setCurrentUser(user){\r\n        this.user = user;\r\n        if(user){\r\n            localStorage.setItem('me', JSON.stringify(user));\r\n            //save to local store\r\n            const userId =`${user._id}`;\r\n            this.users = this.users.set(userId, user);\r\n        }\r\n        this.update();\r\n    }\r\n\r\n\r\n    login(email = null, password = null){\r\n\r\n        const userEmail = _.toLower(email);\r\n        const user = {\r\n            email: userEmail,\r\n            password: password,\r\n        }\r\n        console.log(\"Try login with\", user);\r\n        return new Promise((resolve, reject) => {\r\n\r\n            this.service.post('api/users/login', user).then((res) => {\r\n                //that mean successful login\r\n                const accessToken = _.get(res, 'data'); \r\n                const user = _.get(accessToken, 'user');\r\n\r\n                this.setCurrentUser(user);\r\n                this.setUserToken(accessToken);\r\n\r\n            }).catch((err) => {\r\n                \r\n                const message = _.get(err, 'res.data.err.message', 'Login Error');\r\n                return reject(message);\r\n            })\r\n        });\r\n        // const _this = this;\r\n        // return new Promise((resolve, reject) => {\r\n        //     const user = users.find((user) => user.email === userEmail);\r\n        //     if( user ) {\r\n        //         _this.setCurrentUser(user);\r\n        //     }\r\n        //     return user ? resolve(user) : reject(\"User not found!\")\r\n        // });\r\n    }\r\n\r\n    addUserToChannel(channelId, userId) {\r\n        const channel = this.channels.get(channelId);\r\n        if(channel) {\r\n            channel.members = channel.members.set(userId, true);\r\n            this.channels = this.channels.set(channelId, channel);\r\n        }\r\n        this.update();\r\n    }\r\n    getSearchUsers(){\r\n        // const keyword = _.toLower(search);\r\n\r\n        // let searchItems = new OrderedMap();\r\n        // const currentUser =this.getCurrentUser();\r\n        // const currentUserId = _.get(currentUser, '_id');\r\n       \r\n        // if(_.trim(search).length){\r\n        //    searchItems = users.filter((user) =>_.get(user, '_id') !== currentUserId && _.includes(_.toLower(_.get(user, 'name')), keyword));\r\n        // }\r\n\r\n        return this.search.users.valueSeq();\r\n    }\r\n\r\n    onCreateNewChannel(channel = {}){\r\n        const channelId = _.get(channel, \"_id\");\r\n        this.addChannel(channelId, channel );\r\n        this.setActiveChannelId(channelId);\r\n    \r\n    }\r\n\r\n    getCurrentUser(){\r\n        return this.user;\r\n    }\r\n\r\n    setActiveChannelId(id) {\r\n        this.activeChannelId = id;\r\n        this.update();\r\n    }\r\n    getActiveChannel(){\r\n        const channel = this.activeChannelId ? this.channels.get(this.activeChannelId) : this.channels.first();\r\n        return channel;\r\n    }\r\n\r\n    addMessage(id, message = {}){\r\n\r\n        const user = this.getCurrentUser();\r\n        message.user = user;\r\n        this.messages = this.messages.set(`${id}`, message);\r\n        //add new message to \r\n        const channelId = _.get(message, 'channelId');\r\n        if(channelId){\r\n            let channel = this.channels.get(channelId);\r\n            channel.isNew = false;\r\n            channel.lastMessage = _.get(message, 'body', '');\r\n            channel.messages = channel.messages.set(id, true);\r\n            this.channels = this.channels.set(channelId, channel);\r\n        }\r\n        this.update();\r\n    }\r\n\r\n    removeMemberFromChannel( channel = null, user = null){\r\n        if(!channel || !user ){\r\n            return;\r\n        }\r\n        const channelId = _.get(channel, '_id')\r\n        const userId = _.get(user, '_id');\r\n        channel.members = channel.members.remove(userId);\r\n        this.channels = this.channels.set(channelId, channel);\r\n        this.update();\r\n    }\r\n\r\n    getMessages(){\r\n        return this.messages.valueSeq();\r\n    }\r\n    getMessagesFromChannel(channel){\r\n        let messages = new OrderedMap();\r\n\r\n        if(channel){\r\n            channel.messages.forEach((value, key) => {\r\n\r\n                const message = this.messages.get(key);\r\n                messages = messages.set( key, message);\r\n    \r\n            });\r\n        }\r\n        return messages.valueSeq();\r\n        \r\n    }\r\n\r\n    getMembersFromChannel(channel){\r\n        let members = new OrderedMap();\r\n        if(channel){\r\n            channel.members.forEach((value, key) => {\r\n\r\n                const userId = `${key}`\r\n                const user = this.users.get(userId);\r\n                const loggedUser = this.getCurrentUser();\r\n                if( _.get(loggedUser, '_id') !== _.get(user, '_id')){\r\n                    members = members.set(key, user)\r\n                }\r\n            });\r\n               \r\n        }\r\n        return members.valueSeq();\r\n    }\r\n\r\n\r\n    addChannel(index, channel = {}){\r\n        this.channels = this.channels.set(`${index}`, channel);\r\n        this.update();\r\n    }\r\n\r\n    getChannels(){\r\n        this.channels = this.channels.sort((a, b) => b.created - a.created);\r\n        return this.channels.valueSeq();\r\n    }\r\n    update(){\r\n        this.app.forceUpdate();\r\n    }\r\n}\r\n\r\n"]},"metadata":{},"sourceType":"module"}